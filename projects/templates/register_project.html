{% extends "base.html" %}
{% load static %}

{% block title %}Register Project{% endblock %}

{% block content %}

<h2 class="text-2xl font-bold mb-4">Register New Project</h2>
<div class="max-w-lg mx-auto bg-white p-8 rounded-lg shadow-md">
    <form method="post" action="{% url 'projects:new' %}" id="projectForm">
        {% csrf_token %}
        
        <!-- Project Fields -->
        {% for field in form %}
            {% if field.name == 'public' %}
                <div class="mb-6">
                    <label class="flex items-center text-gray-700 text-sm font-bold">
                        {{ field }}
                        <span class="ml-2">{{ field.label }}</span>
                    </label>
                    {% if field.help_text %}
                        <p class="text-gray-600 text-xs italic mt-1">{{ field.help_text }}</p>
                    {% endif %}
                    {% for error in field.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ error }}</p>
                    {% endfor %}
                </div>
            {% else %}
                <div class="mb-6">
                    <label for="{{ field.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-2">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}
                        <p class="text-gray-600 text-xs italic mt-1">{{ field.help_text }}</p>
                    {% endif %}
                    {% for error in field.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        {% endfor %}

        <div class="mb-6">
            <label for="id_collaborators_select2" class="block text-gray-700 text-sm font-bold mb-2">Collaborators</label>
            <select id="id_collaborators_select2" class="w-full" multiple="multiple"></select>
            <input type="hidden" name="collaborators" id="id_collaborators">
        </div>

        <!-- Components Section -->
        <div class="mt-8 pt-8 border-t-2">
            <h3 class="text-lg font-bold mb-4">Add Components (Optional)</h3>
            
            {{ component_formset.management_form }}
            
            <div id="componentsContainer">
                {% for component_form in component_formset %}
                    <div class="component-form mb-6 p-4 bg-gray-50 rounded-lg component-item">
                        {% if component_form.non_form_errors %}
                            <div class="text-red-500 text-sm mb-2">
                                {% for error in component_form.non_form_errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        {% for field in component_form %}
                            {% if field.name == 'DELETE' %}
                                <div class="flex items-center mt-4">
                                    <label class="flex items-center text-gray-700 text-sm">
                                        {{ field }}
                                        <span class="ml-2">Remove this component</span>
                                    </label>
                                </div>
                            {% else %}
                                <div class="mb-4">
                                    <label for="{{ field.id_for_label }}" class="block text-gray-700 text-sm font-bold mb-2">{{ field.label }}</label>
                                    {{ field }}
                                    {% for error in field.errors %}
                                        <p class="text-red-500 text-xs italic mt-1">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            
            <button type="button" id="addComponentBtn" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                + Add Another Component
            </button>
        </div>

        <!-- Submit Button -->
        <div class="mt-8">
            <button type="submit" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                Register Project
            </button>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addComponentBtn = document.getElementById('addComponentBtn');
    const componentsContainer = document.getElementById('componentsContainer');
    const managementForm = document.querySelector('[name="components-TOTAL_FORMS"]');
    
    function updateFormIndices() {
        const forms = componentsContainer.querySelectorAll('.component-item');
        forms.forEach((form, index) => {
            form.querySelectorAll('input, textarea, select').forEach(field => {
                const name = field.name.replace(/components-\d+/g, `components-${index}`);
                field.name = name;
                
                const id = field.id.replace(/id_components_\d+/g, `id_components_${index}`);
                field.id = id;
            });
            
            const labels = form.querySelectorAll('label');
            labels.forEach(label => {
                if (label.htmlFor) {
                    label.htmlFor = label.htmlFor.replace(/id_components_\d+/g, `id_components_${index}`);
                }
            });
        });
        managementForm.value = forms.length;
    }
    
    addComponentBtn.addEventListener('click', function() {
        const currentFormCount = componentsContainer.querySelectorAll('.component-item').length;
        const newFormHTML = `
            <div class="component-form mb-6 p-4 bg-gray-50 rounded-lg component-item">
                <div class="mb-4">
                    <label for="id_components_${currentFormCount}_name" class="block text-gray-700 text-sm font-bold mb-2">Name</label>
                    <input type="text" name="components-${currentFormCount}-name" placeholder="Component name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="id_components_${currentFormCount}_name">
                </div>
                <div class="mb-4">
                    <label for="id_components_${currentFormCount}_description" class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                    <textarea name="components-${currentFormCount}-description" rows="2" placeholder="Component description" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="id_components_${currentFormCount}_description"></textarea>
                </div>
                <div class="flex items-center mt-4">
                    <label class="flex items-center text-gray-700 text-sm">
                        <input type="checkbox" name="components-${currentFormCount}-DELETE">
                        <span class="ml-2">Remove this component</span>
                    </label>
                </div>
            </div>
        `;
        
        componentsContainer.insertAdjacentHTML('beforeend', newFormHTML);
        updateFormIndices();
    });
});
</script>
<script>
    $(document).ready(function() {
        var $select2 = $('#id_collaborators_select2').select2({
            tags: true,
            tokenSeparators: [',', ' '],
            placeholder: "Enter collaborator emails",
            ajax: {
                url: "{% url 'accounts:user_search' %}",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        term: params.term, // search term
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            },
            multiple: true,
        });

        $select2.on('change', function() {
            var emails = $(this).val();
            $('#id_collaborators').val(emails.join(','));
        });

        // Style the Select2 widget to match the form
        $('.select2-container').css('width', '100%');
        $('.select2-selection--multiple').css({
            'border': '1px solid #e2e8f0',
            'border-radius': '0.375rem',
            'padding': '0.5rem 0.75rem',
            'height': 'auto',
        });
    });
</script>
{% endblock %}
